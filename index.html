<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
  <title>Gmail Viewer – Attachments Enabled</title>
  <script>
    // Google Sign-In callback must be defined before loading the library
    function handleCredentialResponse(response) {
      const decoded = JSON.parse(atob(response.credential.split('.')[1]));
      document.body.insertAdjacentHTML(
        'afterbegin',
        `<p style="text-align:center;">Welcome, ${decoded.name}</p>`
      );
      tokenClient.requestAccessToken();
    }
  </script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background-color: #f4f7fa; color: #333; }
    h1 { text-align: center; margin-bottom: 10px; }
    #filterSection { text-align: center; margin-bottom: 30px; }
    #filterSection select, #searchInput, #searchButton, #newFolderInput {
      padding: 8px; font-size: 1em; margin: 0 5px;
    }
    #emails { list-style: none; padding: 0; max-width: 800px; margin: 0 auto; }
    #emails li {
      background: #fff; margin-bottom: 20px; padding: 20px;
      border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .subject { font-weight: 700; font-size: 1.1em; color: #004d99; cursor: pointer; }
    .subject.read { font-weight: normal; }
    .meta { font-size: 0.9em; color: #777; margin-bottom: 10px; }
    .email-body { margin-top: 10px; background: #f2f2f2; padding: 10px; border-radius: 5px; white-space: pre-wrap; }
    .thread-body { margin-top: 15px; padding-left: 15px; border-left: 3px solid #ccc; }
    .thread-container { display: none; }
    #backToTop {
      position: fixed; bottom: 20px; right: 20px; display: none;
      background-color: #0073e6; color: white; border: none;
      padding: 10px 20px; border-radius: 5px; cursor: pointer;
    }
    .new-badge { color: red; font-size: 0.9em; font-weight: bold; margin-left: 10px; }
  </style>
</head>
<body>
  <h1>My Gmail Inbox</h1>

  <div id="g_id_onload"
       data-client_id="474892923870-2r0ksjol93ve88881n7p2glmv7onpd4l.apps.googleusercontent.com"
       data-context="use"
       data-ux_mode="popup"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false"
       data-scope="https://www.googleapis.com/auth/gmail.modify">
  </div>

  <div class="g_id_signin"
       data-type="standard"
       data-shape="rectangular"
       data-theme="outline"
       data-text="signin_with"
       data-size="large"
       data-logo_alignment="left">
  </div>

  <!-- Filters & Folder UI -->
  <div id="filterSection">
    <label for="timeFilter">Time:</label>
    <select id="timeFilter" onchange="refreshInbox(currentLabelId)">
      <option value="24h">Last 24 Hours</option>
      <option value="7d">Last 7 Days</option>
      <option value="all" selected>All</option>
    </select>

    <label for="labelFilter">Label:</label>
    <select id="labelFilter" onchange="refreshInbox(this.value)">
      <option value="INBOX">Inbox</option>
      <option value="SENT">Sent Mail</option>
      <option value="DRAFT">Drafts</option>
      <option value="SPAM">Junk / Spam</option>
      <option value="TRASH">Deleted Items</option>
    </select>

    <input type="text" id="searchInput" placeholder="Search keywords...">
    <button id="searchButton" onclick="refreshInbox(currentLabelId)">Search</button>

    <br><br>
    <input type="text" id="newFolderInput" placeholder="New folder name..." />
    <button onclick="createFolder()">Create Folder</button>

    <div id="folderDropZone" style="margin-top:20px;">
      <h3>Your Folders</h3>
      <div id="folderList" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px;"></div>
    </div>
  </div>

  <!-- Folder Title -->
  <h2 id="currentFolderName"
      style="text-align:center; color:#0073e6; margin-bottom:20px;"
      data-folder-name="Inbox">Inbox</h2>

  <!-- Emails -->
  <ul id="emails"></ul>
  <button id="backToTop" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
    Back to Top
  </button>

  <!-- Floating Compose Panel -->
  <div id="composeBox" style="
    position: fixed;
    top: 40px;
    right: 40px;
    width: 300px;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    z-index: 9999;
  ">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3 style="margin:0;">Compose</h3>
      <button onclick="toggleCompose(event)"
              style="background:none;border:none;font-size:16px;cursor:pointer;">
        ➖
      </button>
    </div>
    <div id="composeForm">
      <input id="toEmail" type="email" placeholder="To" style="width:100%;padding:8px;margin:8px 0;" />
      <input id="emailSubject" type="text" placeholder="Subject" style="width:100%;padding:8px;margin:8px 0;" />
      <textarea id="emailBody" placeholder="Message..." style="width:100%;padding:8px;height:100px;"></textarea>
      <label for="attachmentInput">Attachments:</label>
      <input type="file" id="attachmentInput" multiple style="width:100%;margin:8px 0;" />
      <button onclick="sendEmail()"
              style="margin-top:10px;padding:8px 16px;background:#0073e6;color:white;border:none;border-radius:5px;cursor:pointer;">
        Send
      </button>
    </div>
  </div>

  <!-- Floating “new compose” button -->
  <button id="composeToggleBtn" onclick="showCompose()"
          style="position:fixed;bottom:30px;right:30px;background:#0073e6;color:white;border:none;
                 border-radius:50%;width:50px;height:50px;font-size:24px;cursor:pointer;
                 box-shadow:0 2px 6px rgba(0,0,0,0.2);display:none;z-index:9999;">
    +
  </button>

<script>
  let access_token = '';
  let tokenClient;
  let labelList = [];
  let nextPageToken = '';
  let loading = false;
  let currentLabelId = 'INBOX';

  function initializeTokenClient() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: '474892923870-2r0ksjol93ve88881n7p2glmv7onpd4l.apps.googleusercontent.com',
      scope: 'https://www.googleapis.com/auth/gmail.modify',
      callback: (resp) => {
        access_token = resp.access_token;
        loadLabels();
        refreshInbox(currentLabelId);
        setInterval(() => refreshInbox(currentLabelId), 120000);
      }
    });
  }

  window.onload = () => {
    if (window.google && google.accounts) initializeTokenClient();
    else setTimeout(() => {
      if (window.google && google.accounts) initializeTokenClient();
    }, 1000);

    // Restore compose state
    const saved = localStorage.getItem('composeCollapsed');
    const form = document.getElementById('composeForm');
    const floatBtn = document.getElementById('composeToggleBtn');
    if (saved === 'true') {
      form.style.display = 'none';
      floatBtn.style.display = 'block';
    }
  };

  function toggleCompose(e) {
    const form = document.getElementById('composeForm');
    const btn = e.currentTarget;
    const hidden = form.style.display === 'none';
    form.style.display = hidden ? 'block' : 'none';
    btn.textContent = hidden ? '➖' : '➕';
    document.getElementById('composeToggleBtn').style.display = hidden ? 'none' : 'block';
    localStorage.setItem('composeCollapsed', hidden ? 'false' : 'true');
  }

  function showCompose() {
    document.getElementById('composeForm').style.display = 'block';
    document.querySelector('#composeBox button').textContent = '➖';
    document.getElementById('composeToggleBtn').style.display = 'none';
    localStorage.setItem('composeCollapsed', 'false');
  }

  function sendEmail() {
    const to = document.getElementById('toEmail').value.trim();
    const subject = document.getElementById('emailSubject').value.trim();
    const body = document.getElementById('emailBody').value;
    const files = document.getElementById('attachmentInput').files;

    if (!to || !subject) {
      alert('Please fill in To and Subject.');
      return;
    }

    // If there are attachments, build a multipart/mixed message
    if (files.length > 0) {
      const boundary = '===boundary_' + Date.now() + '===';
      // Text part
      const textPart = [
        `--${boundary}`,
        'Content-Type: text/plain; charset=UTF-8',
        'Content-Transfer-Encoding: 7bit',
        '',
        body || ''
      ].join('\r\n');

      // Read each file as base64
      const promises = Array.from(files).map(file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64Data = reader.result.split(',')[1];
          const attachmentPart = [
            `--${boundary}`,
            `Content-Type: ${file.type || 'application/octet-stream'}; name="${file.name}"`,
            `Content-Disposition: attachment; filename="${file.name}"`,
            'Content-Transfer-Encoding: base64',
            '',
            base64Data
          ].join('\r\n');
          resolve(attachmentPart);
        };
        reader.onerror = () => reject(reader.error);
        reader.readAsDataURL(file);
      }));

      Promise.all(promises)
        .then(parts => {
          const allParts = [textPart].concat(parts).concat([`--${boundary}--`]);
          const rawMessage = [
            `To: ${to}`,
            `Subject: ${subject}`,
            'MIME-Version: 1.0',
            `Content-Type: multipart/mixed; boundary="${boundary}"`,
            '',
            allParts.join('\r\n')
          ].join('\r\n');

          const encoded = btoa(rawMessage)
            .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');

          return fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/send', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${access_token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ raw: encoded })
          });
        })
        .then(res => {
          if (res.ok) {
            alert('Email sent with attachments!');
            document.getElementById('toEmail').value = '';
            document.getElementById('emailSubject').value = '';
            document.getElementById('emailBody').value = '';
            document.getElementById('attachmentInput').value = '';
          } else {
            alert('Failed to send email with attachments.');
          }
        })
        .catch(err => {
          console.error(err);
          alert('Error sending email: ' + err.message);
        });

    } else {
      // No attachments: simple single-part send
      const msg = `To: ${to}\r\nSubject: ${subject}\r\nContent-Type: text/plain; charset="UTF-8"\r\n\r\n${body}`;
      const encoded = btoa(msg)
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');

      fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/send', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${access_token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ raw: encoded })
      })
      .then(res => {
        if (res.ok) {
          alert('Email sent!');
          document.getElementById('toEmail').value = '';
          document.getElementById('emailSubject').value = '';
          document.getElementById('emailBody').value = '';
        } else {
          alert('Failed to send email.');
        }
      })
      .catch(err => {
        console.error(err);
        alert('Error sending email.');
      });
    }
  }

  // —— (the rest of your loadLabels(), renderFolderDropTargets(), refreshInbox(), loadInbox(),
  //      toggleThread(), labelThread(), and onscroll logic remains unchanged) ——
</script>
</body>
</html>

