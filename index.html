<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gmail Viewer – Floating Compose</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background-color: #f4f7fa; color: #333; }
    h1 { text-align: center; margin-bottom: 10px; }
    #filterSection { text-align: center; margin-bottom: 30px; }
    #filterSection select, #searchInput, #searchButton, #newFolderInput {
      padding: 8px; font-size: 1em; margin: 0 5px;
    }
    #emails { list-style: none; padding: 0; max-width: 800px; margin: 0 auto; }
    #emails li {
      background: #fff; margin-bottom: 20px; padding: 20px;
      border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .subject {
      font-weight: 700; font-size: 1.1em; color: #004d99; cursor: pointer;
    }
    .subject.read { font-weight: normal; }
    .meta { font-size: 0.9em; color: #777; margin-bottom: 10px; }
    .email-body {
      margin-top: 10px; background: #f2f2f2;
      padding: 10px; border-radius: 5px; white-space: pre-wrap;
    }
    .thread-body {
      margin-top: 15px; padding-left: 15px; border-left: 3px solid #ccc;
    }
    .thread-container { display: none; }
    #backToTop {
      position: fixed; bottom: 20px; right: 20px; display: none;
      background-color: #0073e6; color: white; border: none;
      padding: 10px 20px; border-radius: 5px; cursor: pointer;
    }
    .new-badge {
      color: red; font-size: 0.9em; font-weight: bold; margin-left: 10px;
    }
  </style>
</head>
<body>
  <h1>My Gmail Inbox</h1>

  <!-- Google Sign-In callback must be defined before loading the library -->
  <script>
    function handleCredentialResponse(response) {
      const decoded = JSON.parse(atob(response.credential.split('.')[1]));
      document.body.insertAdjacentHTML(
        'afterbegin',
        `<p style="text-align:center;">Welcome, ${decoded.name}</p>`
      );
      tokenClient.requestAccessToken();
    }
  </script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <div id="g_id_onload"
       data-client_id="474892923870-2r0ksjol93ve88881n7p2glmv7onpd4l.apps.googleusercontent.com"
       data-context="use"
       data-ux_mode="popup"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false"
       data-scope="https://www.googleapis.com/auth/gmail.modify"></div>

  <div class="g_id_signin"
       data-type="standard"
       data-shape="rectangular"
       data-theme="outline"
       data-text="signin_with"
       data-size="large"
       data-logo_alignment="left"></div>

  <!-- Filters & Folder UI -->
  <div id="filterSection">
    <label for="timeFilter">Time:</label>
    <select id="timeFilter" onchange="refreshInbox(currentLabelId)">
      <option value="24h">Last 24 Hours</option>
      <option value="7d">Last 7 Days</option>
      <option value="all" selected>All</option>
    </select>

    <label for="labelFilter">Label:</label>
    <select id="labelFilter" onchange="refreshInbox(this.value)">
      <option value="INBOX">Inbox</option>
      <option value="SENT">Sent Mail</option>
      <option value="DRAFT">Drafts</option>
      <option value="SPAM">Junk / Spam</option>
      <option value="TRASH">Deleted Items</option>
    </select>

    <input type="text" id="searchInput" placeholder="Search keywords...">
    <button id="searchButton" onclick="refreshInbox(currentLabelId)">Search</button>

    <br><br>
    <input type="text" id="newFolderInput" placeholder="New folder name..." />
    <button onclick="createFolder()">Create Folder</button>

    <div id="folderDropZone" style="margin-top:20px;">
      <h3>Your Folders</h3>
      <div id="folderList" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px;"></div>
    </div>
  </div>

  <!-- Folder Title -->
  <h2 id="currentFolderName" style="text-align:center; color:#0073e6; margin-bottom:20px;" data-folder-name="Inbox">Inbox</h2>

  <!-- Emails -->
  <ul id="emails"></ul>
  <button id="backToTop" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">Back to Top</button>

  <!-- Floating Compose Panel -->
  <div id="composeBox" style="
    position: fixed;
    top: 40px;
    right: 40px;
    width: 300px;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    z-index: 9999;
  ">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3 style="margin:0;">Compose</h3>
      <button onclick="toggleCompose(event)" style="background:none;border:none;font-size:16px;cursor:pointer;">➖</button>
    </div>
    <div id="composeForm">
      <input id="toEmail" type="email" placeholder="To" style="width:100%;padding:8px;margin:8px 0;" />
      <input id="emailSubject" type="text" placeholder="Subject" style="width:100%;padding:8px;margin:8px 0;" />
      <textarea id="emailBody" placeholder="Message..." style="width:100%;padding:8px;height:100px;"></textarea>
      <button onclick="sendEmail()" style="margin-top:10px;padding:8px 16px;background:#0073e6;color:white;border:none;border-radius:5px;cursor:pointer;">Send</button>
    </div>
  </div>

  <!-- Floating New Email Button -->
  <button id="composeToggleBtn" onclick="showCompose()"
    style="position:fixed;bottom:30px;right:30px;background:#0073e6;color:white;border:none;
           border-radius:50%;width:50px;height:50px;font-size:24px;cursor:pointer;
           box-shadow:0 2px 6px rgba(0,0,0,0.2);display:none;z-index:9999;">
    +
  </button>

<script>
  let access_token = '';
  let tokenClient;
  let labelList = [];
  let nextPageToken = '';
  let loading = false;
  let currentLabelId = 'INBOX';

  function initializeTokenClient() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: '474892923870-2r0ksjol93ve88881n7p2glmv7onpd4l.apps.googleusercontent.com',
      scope: 'https://www.googleapis.com/auth/gmail.modify',
      callback: (resp) => {
        access_token = resp.access_token;
        loadLabels();
        refreshInbox(currentLabelId);
        setInterval(() => refreshInbox(currentLabelId), 120000);
      }
    });
  }

  window.onload = function () {
    if (window.google && google.accounts) initializeTokenClient();
    else setTimeout(() => { if (window.google && google.accounts) initializeTokenClient(); }, 1000);

    // Restore compose state
    const saved = localStorage.getItem('composeCollapsed');
    const form = document.getElementById('composeForm');
    const floatingBtn = document.getElementById('composeToggleBtn');
    if (saved === 'true') {
      form.style.display = 'none';
      floatingBtn.style.display = 'block';
    }
  };

  function toggleCompose(e) {
    const form = document.getElementById('composeForm');
    const btn = e.currentTarget;
    const hidden = form.style.display === 'none';
    form.style.display = hidden ? 'block' : 'none';
    btn.textContent = hidden ? '➖' : '➕';
    document.getElementById('composeToggleBtn').style.display = hidden ? 'none' : 'block';
    localStorage.setItem('composeCollapsed', hidden ? 'false' : 'true');
  }

  function showCompose() {
    document.getElementById('composeForm').style.display = 'block';
    document.querySelector('#composeBox button').textContent = '➖';
    document.getElementById('composeToggleBtn').style.display = 'none';
    localStorage.setItem('composeCollapsed', 'false');
  }

  function sendEmail() {
    const to = document.getElementById('toEmail').value;
    const subject = document.getElementById('emailSubject').value;
    const body = document.getElementById('emailBody').value;
    if (!to || !subject || !body) { alert('Please fill in all fields.'); return; }
    const msg = `To: ${to}\r\nSubject: ${subject}\r\nContent-Type: text/plain; charset="UTF-8"\r\n\r\n${body}`;
    const raw = btoa(msg).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/send', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${access_token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ raw })
    })
    .then(r => r.ok ? alert('Email sent!') : alert('Failed to send email.'))
    .catch(() => alert('Error sending email.'));
  }

  function createFolder() {
    const name = document.getElementById('newFolderInput').value.trim();
    if (!name) { alert('Please enter a folder name.'); return; }
    fetch('https://gmail.googleapis.com/gmail/v1/users/me/labels', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${access_token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, labelListVisibility:'labelShow', messageListVisibility:'show' })
    })
    .then(res => res.json())
    .then(data => data.id ? (alert(`Folder "${name}" created!`), loadLabels()) : alert('Failed to create folder.'))
    .catch(() => alert('Error creating folder.'));
  }

  function loadLabels() {
    fetch('https://gmail.googleapis.com/gmail/v1/users/me/labels', { headers:{ 'Authorization': `Bearer ${access_token}` } })
      .then(r=>r.json()).then(d=>{
        labelList = d.labels.filter(l=>l.type==='user');
        renderFolderDropTargets();
      });
  }

  function renderFolderDropTargets() {
    const c = document.getElementById('folderList');
    c.innerHTML = '';
    const mkBtn = (text, id)=>{
      const d = document.createElement('div');
      d.textContent = text;
      d.setAttribute('data-label-id', id || 'INBOX');
      d.style.cssText = `padding:10px 15px; background:#0073e6; color:white; border-radius:6px; cursor:pointer; margin-bottom:10px;`;
      d.ondragover = e=>e.preventDefault();
      d.ondrop = e=>{ const tid=e.dataTransfer.getData('thread-id'); moveThreadToFolder(tid,id); };
      d.onclick = ()=>{ currentLabelId = id||'INBOX'; setActiveFolder(d); refreshInbox(currentLabelId); };
      return d;
    };
    c.appendChild(mkBtn('Inbox', 'INBOX'));
    labelList.forEach(l=>c.appendChild(mkBtn(l.name,l.id)));
  }

  function setActiveFolder(el) {
    document.querySelectorAll('#folderList > div').forEach(d=>d.style.outline='none');
    el.style.outline='3px solid #fff'; el.style.boxShadow='0 0 0 3px #0073e6';
    document.getElementById('currentFolderName').textContent = el.textContent.trim();
  }

  function getTimeQuery() {
    const tf = document.getElementById('timeFilter').value;
    const s = document.getElementById('searchInput').value.trim();
    const now = Date.now();
    const parts = [];
    if(tf==='24h') parts.push('after:'+ Math.floor((now-86400000)/1000));
    if(tf==='7d') parts.push('after:'+ Math.floor((now-604800000)/1000));
    if(s) parts.push(s);
    return parts.join(' ');
  }

  function refreshInbox(labelId) {
    currentLabelId=labelId||currentLabelId; nextPageToken=''; document.getElementById('emails').innerHTML=''; loadInbox();
  }

  function loadInbox() {
    if (loading) return; loading=true;
    const q=getTimeQuery();
    const url=new URL('https://gmail.googleapis.com/gmail/v1/users/me/threads');
    url.searchParams.set('maxResults','10'); if(q) url.searchParams.set('q',q);
    if(nextPageToken) url.searchParams.set('pageToken',nextPageToken);
    if(currentLabelId && currentLabelId!=='all') url.searchParams.set('labelIds',currentLabelId);

    fetch(url, { headers:{ 'Authorization': `Bearer ${access_token}` } })
      .then(r=>r.json()).then(d=>{
        loading=false; if(!d.threads) return;
        nextPageToken = d.nextPageToken||'';
        return Promise.all(d.threads.map(t=>
          fetch(`https://gmail.googleapis.com/gmail/v1/users/me/threads/${t.id}`,
            { headers:{ 'Authorization': `Bearer ${access_token}` } }
          ).then(r=>r.json())
        ));
      })
      .then(threads=>{
        const sorted = threads.sort((a,b)=>(parseInt(b.messages.slice(-1)[0].internalDate) - parseInt(a.messages.slice(-1)[0].internalDate)));
        const list = document.getElementById('emails');
        sorted.forEach(th=>{
          const item = document.createElement('li');
          item.setAttribute('data-thread-id', th.id);
          item.setAttribute('draggable', true);
          item.ondragstart = e=> e.dataTransfer.setData('thread-id', th.id);

          const msgs = th.messages.sort((a,b)=>parseInt(b.internalDate)-parseInt(a.internalDate));
          const newest = msgs[0];
          const subj = newest.payload.headers.find(h=>h.name==='Subject')?.value || '(No Subject)';
          const isUnread = newest.labelIds?.includes('UNREAD');
          const badge = isUnread ? `<span class="new-badge">NEW</span>` : '';

          let threadHtml = '';
          msgs.forEach(m=>{
            const from = m.payload.headers.find(h=>h.name==='From')?.value; 
            const date = new Date(parseInt(m.internalDate)).toLocaleString();
            const part = m.payload.parts?.find(p=>p.mimeType==='text/plain')||m.payload;
            const body = part.body.data ? atob(part.body.data.replace(/-/g,'+').replace(/_/g,'/')) : '(No body)';
            threadHtml +=
              `<div class="thread-body">
                <div class="meta">From: ${from}<br>Date: ${date}</div>
                <div class="email-body">${body}</div>
              </div>`;
          });

          const options = labelList.map(l=>`<option value="${l.id}">${l.name}</option>`).join('');

          item.innerHTML =
            `<div class="subject${isUnread?'':' read'}" onclick="toggleThread(this)">
               ${subj}${badge}
               <span style="float:right; font-size:0.85em; color:#666;">${new Date(parseInt(newest.internalDate)).toLocaleString()}</span>
             </div>
             <div style="margin-top:10px;">
               <label>Move to Folder:</label>
               <select onchange="labelThread(this,'${th.id}')">
                 <option value="">Select folder</option>
                 ${options}
               </select>
             </div>
             <div class="thread-container">
               ${threadHtml}
             </div>`;
          list.appendChild(item);
        });
        const h2 = document.getElementById('currentFolderName');
        h2.textContent = `${h2.getAttribute('data-folder-name')} (${sorted.length} msgs${sorted.filter(t=>t.messages[0].labelIds?.includes('UNREAD')).length>0?`, ${sorted.filter(t=>t.messages[0].labelIds?.includes('UNREAD')).length} unread`:''})`;
      });
  }

  function toggleThread(el) {
    const container = el.parentElement.querySelector('.thread-container');
    if (container) container.style.display = container.style.display==='none'?'block':'none';
    el.classList.add('read');
    const badge = el.querySelector('.new-badge'); if (badge) badge.remove();
    const tid = el.closest('li').dataset.threadId;
    fetch(`https://gmail.googleapis.com/gmail/v1/users/me/threads/${tid}/modify`, {
      method:'POST', headers:{ 'Authorization':`Bearer ${access_token}`, 'Content-Type':'application/json' },
      body:JSON.stringify({ removeLabelIds:['UNREAD'] })
    });
  }

  function labelThread(sel, tid) {
    const lid = sel.value; if(!lid) return;
    fetch(`https://gmail.googleapis.com/gmail/v1/users/me/threads/${tid}/modify`, {
      method:'POST', headers:{ 'Authorization':`Bearer ${access_token}`, 'Content-Type':'application/json' },
      body:JSON.stringify({ addLabelIds:[lid], removeLabelIds:['INBOX'] })
    }).then(()=> refreshInbox(currentLabelId));
  }

  window.onscroll = function() {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 50) loadInbox();
    document.getElementById('backToTop').style.display = window.scrollY>300?'block':'none';
  };
</script>
</body>
</html>
