<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gmail Viewer with Filters & Notifications</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 40px;
      background-color: #f4f7fa;
      color: #333;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    #filterSection {
      text-align: center;
      margin-bottom: 30px;
    }

    #timeFilter {
      padding: 8px;
      font-size: 1em;
    }

    #emails {
      list-style: none;
      padding: 0;
      max-width: 800px;
      margin: 0 auto;
    }

    #emails li {
      background: #fff;
      margin-bottom: 20px;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .subject {
      font-weight: 600;
      font-size: 1.1em;
      margin-bottom: 5px;
      color: #004d99;
    }

    pre {
      background: #f2f2f2;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
    }

    .reply-box {
      margin-top: 15px;
    }

    .reply-box textarea {
      width: 100%;
      height: 80px;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      resize: vertical;
      font-size: 0.95em;
    }

    .reply-box button {
      margin-top: 10px;
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      background-color: #0073e6;
      color: white;
      cursor: pointer;
      font-size: 0.95em;
    }

    .reply-box button:hover {
      background-color: #005bb5;
    }
  </style>
</head>
<body>
  <h1>My Gmail Inbox</h1>

  <div id="g_id_onload"
       data-client_id="YOUR_CLIENT_ID"
       data-context="use"
       data-ux_mode="popup"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false"
       data-scope="https://www.googleapis.com/auth/gmail.modify">
  </div>

  <div class="g_id_signin"
       data-type="standard"
       data-shape="rectangular"
       data-theme="outline"
       data-text="signin_with"
       data-size="large"
       data-logo_alignment="left">
  </div>

  <div id="filterSection">
    <label for="timeFilter">Show: </label>
    <select id="timeFilter" onchange="loadInbox()">
      <option value="24h">Last 24 Hours</option>
      <option value="7d">Last 7 Days</option>
      <option value="all" selected>All</option>
    </select>
  </div>

  <ul id="emails"></ul>

  <script>
    let access_token = '';
    let tokenClient;
    let lastMessageId = null;

    function initializeTokenClient() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: 'YOUR_CLIENT_ID',
        scope: 'https://www.googleapis.com/auth/gmail.modify',
        callback: (response) => {
          access_token = response.access_token;
          requestNotificationPermission();
          loadInbox();
          setInterval(loadInbox, 60000); // Check every 60 sec
        },
      });
    }

    function handleCredentialResponse(response) {
      const decoded = JSON.parse(atob(response.credential.split('.')[1]));
      document.body.insertAdjacentHTML('afterbegin', `<p style="text-align:center;">Welcome, ${decoded.name}</p>`);
      tokenClient.requestAccessToken();
    }

    function requestNotificationPermission() {
      if (Notification.permission !== 'granted') {
        Notification.requestPermission();
      }
    }

    function getTimeQuery() {
      const filter = document.getElementById('timeFilter').value;
      const now = new Date();
      const qParts = [];

      if (filter === '24h') {
        const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        qParts.push('after:' + formatDate(yesterday));
      } else if (filter === '7d') {
        const lastWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        qParts.push('after:' + formatDate(lastWeek));
      }

      return qParts.join(' ');
    }

    function formatDate(date) {
      return date.toISOString().split('T')[0].replace(/-/g, '/');
    }

    function loadInbox() {
      const query = getTimeQuery();
      const url = new URL('https://gmail.googleapis.com/gmail/v1/users/me/messages');
      url.searchParams.set('maxResults', '5');
      if (query) url.searchParams.set('q', query);

      fetch(url, { headers: { 'Authorization': `Bearer ${access_token}` } })
      .then(res => res.json())
      .then(data => {
        if (!data.messages) return;

        const newestMessageId = data.messages[0]?.id;
        if (lastMessageId && newestMessageId && newestMessageId !== lastMessageId) {
          new Notification('ðŸ“¬ New Email Received!');
        }
        lastMessageId = newestMessageId;

        const list = document.getElementById('emails');
        list.innerHTML = '';
        data.messages.forEach(msg => {
          fetch(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${msg.id}`, {
            headers: { 'Authorization': `Bearer ${access_token}` }
          })
          .then(res => res.json())
          .then(fullMsg => {
            const headers = fullMsg.payload.headers;
            const subject = headers.find(h => h.name === 'Subject')?.value || '(No Subject)';
            const from = headers.find(h => h.name === 'From')?.value || '(Unknown)';
            const part = fullMsg.payload.parts?.find(p => p.mimeType === 'text/plain') || fullMsg.payload;
            const body = part.body.data ? atob(part.body.data.replace(/-/g, '+').replace(/_/g, '/')) : '(No body)';

            const item = document.createElement('li');
            item.innerHTML = `
              <div class="subject">${subject}</div>
              <div><strong>From:</strong> ${from}</div>
              <pre>${body}</pre>
              <div class="reply-box">
                <textarea placeholder="Reply..."></textarea>
                <button onclick="sendReply('${from}', '${subject}', this)">Send Reply</button>
              </div>
            `;
            list.appendChild(item);
          });
        });
      });
    }

    function sendReply(to, subject, button) {
      const textarea = button.previousElementSibling;
      const messageBody = textarea.value.trim();
      if (!messageBody) return alert('Please write a reply.');

      const raw = [
        `To: ${to}`,
        `Subject: Re: ${subject}`,
        '',
        messageBody
      ].join('\n');

      const base64EncodedEmail = btoa(raw)
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');

      fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/send', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${access_token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ raw: base64EncodedEmail })
      })
      .then(res => res.json())
      .then(data => {
        alert('Reply sent!');
        textarea.value = '';
      })
      .catch(err => {
        console.error('Failed to send reply:', err);
        alert('Failed to send reply.');
      });
    }

    window.onload = function () {
      if (window.google && google.accounts) {
        initializeTokenClient();
      } else {
        window.setTimeout(() => {
          if (window.google && google.accounts) {
            initializeTokenClient();
          } else {
            console.error("Google Identity Services SDK failed to load.");
          }
        }, 1000);
      }
    };
  </script>
</body>
</html>
