<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
  <title>Gmail Viewer – Secure</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background-color: #f4f7fa; color: #333; }
    h1 { text-align: center; margin-bottom: 10px; }
    #filterSection { text-align: center; margin-bottom: 30px; }
    #filterSection select, #searchInput, #searchButton, #newFolderInput {
      padding: 8px; font-size: 1em; margin: 0 5px;
    }
    #emails { list-style: none; padding: 0; max-width: 800px; margin: 0 auto; }
    #emails li {
      background: #fff; margin-bottom: 20px; padding: 20px;
      border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .subject {
      font-weight: 700; font-size: 1.1em; color: #004d99; cursor: pointer;
    }
    .subject.read { font-weight: normal; }
    .meta { font-size: 0.9em; color: #777; margin-bottom: 10px; }
    .email-body {
      margin-top: 10px; background: #f2f2f2;
      padding: 10px; border-radius: 5px; white-space: pre-wrap;
    }
    .thread-body {
      margin-top: 15px; padding-left: 15px; border-left: 3px solid #ccc;
    }
    .thread-container { display: none; }
    #backToTop {
      position: fixed; bottom: 20px; right: 20px; display: none;
      background-color: #0073e6; color: white; border: none;
      padding: 10px 20px; border-radius: 5px; cursor: pointer;
    }
    .new-badge {
      color: red; font-size: 0.9em; font-weight: bold; margin-left: 10px;
    }
  </style>
</head>
<body>
  <h1>My Gmail Inbox</h1>

  <!-- Google Sign-In -->
  <div id="g_id_onload"
       data-client_id="474892923870-2r0ksjol93ve88881n7p2glmv7onpd4l.apps.googleusercontent.com"
       data-context="use"
       data-ux_mode="popup"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false"
       data-scope="https://www.googleapis.com/auth/gmail.modify"></div>

  <div class="g_id_signin"
       data-type="standard"
       data-shape="rectangular"
       data-theme="outline"
       data-text="signin_with"
       data-size="large"
       data-logo_alignment="left"></div>

  <!-- Filters & Folder UI -->
  <div id="filterSection">
    <label for="timeFilter">Time:</label>
    <select id="timeFilter" onchange="refreshInbox(currentLabelId)">
      <option value="24h">Last 24 Hours</option>
      <option value="7d">Last 7 Days</option>
      <option value="all" selected>All</option>
    </select>

    <label for="labelFilter">Label:</label>
    <select id="labelFilter" onchange="refreshInbox(this.value)">
      <option value="INBOX">Inbox</option>
      <option value="SENT">Sent Mail</option>
      <option value="DRAFT">Drafts</option>
      <option value="SPAM">Junk / Spam</option>
      <option value="TRASH">Deleted Items</option>
    </select>

    <input type="text" id="searchInput" placeholder="Search keywords...">
    <button id="searchButton" onclick="refreshInbox(currentLabelId)">Search</button>

    <br><br>
    <input type="text" id="newFolderInput" placeholder="New folder name..." />
    <button onclick="createFolder()">Create Folder</button>

    <div id="folderDropZone" style="margin-top:20px;">
      <h3>Your Folders</h3>
      <div id="folderList" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px;"></div>
    </div>
  </div>
<script>
  let access_token = '';
  let tokenClient;
  let labelList = [];
  let nextPageToken = '';
  let loading = false;
  let currentLabelId = 'INBOX';

  // ✅ Fix for "callback not a function"
  window.handleCredentialResponse = function (response) {
    const decoded = JSON.parse(atob(response.credential.split('.')[1]));
    document.body.insertAdjacentHTML('afterbegin', `<p style='text-align:center;'>Welcome, ${decoded.name}</p>`);
    initializeTokenClient('consent');
  };

  function initializeTokenClient(promptMode = 'consent') {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: '474892923870-2r0ksjol93ve88881n7p2glmv7onpd4l.apps.googleusercontent.com',
      scope: 'https://www.googleapis.com/auth/gmail.modify',
      prompt: promptMode,
      callback: (response) => {
        if (response && response.access_token) {
          access_token = response.access_token;
          loadLabels();
          refreshInbox(currentLabelId);
          setInterval(() => refreshInbox(currentLabelId), 120000);
        } else {
          console.warn('No access token retrieved');
        }
      },
    });

    // Try silent refresh first
    if (promptMode === 'none') {
      tokenClient.requestAccessToken();
    }
  }

  window.onload = function () {
    if (window.google && google.accounts) {
      initializeTokenClient('none'); // try silent login
    } else {
      setTimeout(() => {
        if (window.google && google.accounts) {
          initializeTokenClient('none');
        }
      }, 1000);
    }

    // Restore compose box state
    const savedState = localStorage.getItem('composeCollapsed');
    const form = document.getElementById('composeForm');
    const toggleBtn = document.querySelector('#composeBox button');
    const floatingBtn = document.getElementById('composeToggleBtn');

    if (savedState === 'true') {
      if (form && toggleBtn) {
        form.style.display = 'none';
        toggleBtn.textContent = '➕';
        floatingBtn.style.display = 'block';
      }
    }
  };

  function toggleCompose() {
    const form = document.getElementById('composeForm');
    const toggleBtn = event.target;
    const isCollapsed = form.style.display === 'none';
    form.style.display = isCollapsed ? 'block' : 'none';
    toggleBtn.textContent = isCollapsed ? '➖' : '➕';
    document.getElementById('composeToggleBtn').style.display = isCollapsed ? 'none' : 'block';
    localStorage.setItem('composeCollapsed', isCollapsed ? 'false' : 'true');
  }

  function showCompose() {
    const form = document.getElementById('composeForm');
    const toggleBtn = document.querySelector('#composeBox button');
    form.style.display = 'block';
    toggleBtn.textContent = '➖';
    document.getElementById('composeToggleBtn').style.display = 'none';
    localStorage.setItem('composeCollapsed', 'false');
  }

  function sendEmail() {
    const to = document.getElementById("toEmail").value;
    const subject = document.getElementById("emailSubject").value;
    const body = document.getElementById("emailBody").value;

    if (!to || !subject || !body) {
      alert("Please fill in all fields.");
      return;
    }

    const message =
      `To: ${to}\r\n` +
      `Subject: ${subject}\r\n` +
      `Content-Type: text/plain; charset="UTF-8"\r\n` +
      `\r\n${body}`;

    const encodedMessage = btoa(message)
      .replace(/\+/g, '-')
      .replace(/\//g, '_')
      .replace(/=+$/, '');

    fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/send', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${access_token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ raw: encodedMessage })
    })
    .then(res => {
      if (res.ok) {
        alert("Email sent!");
        document.getElementById("toEmail").value = '';
        document.getElementById("emailSubject").value = '';
        document.getElementById("emailBody").value = '';
      } else {
        alert("Failed to send email.");
      }
    })
    .catch(err => {
      console.error(err);
      alert("Error sending email.");
    });
  }
</script>
<script>
  let access_token = '';
  let tokenClient;
  let labelList = [];
  let nextPageToken = '';
  let loading = false;
  let currentLabelId = 'INBOX';

  // ✅ Fix for "callback not a function"
  window.handleCredentialResponse = function (response) {
    const decoded = JSON.parse(atob(response.credential.split('.')[1]));
    document.body.insertAdjacentHTML('afterbegin', `<p style='text-align:center;'>Welcome, ${decoded.name}</p>`);
    initializeTokenClient('consent');
  };

  function initializeTokenClient(promptMode = 'consent') {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: '474892923870-2r0ksjol93ve88881n7p2glmv7onpd4l.apps.googleusercontent.com',
      scope: 'https://www.googleapis.com/auth/gmail.modify',
      prompt: promptMode,
      callback: (response) => {
        if (response && response.access_token) {
          access_token = response.access_token;
          loadLabels();
          refreshInbox(currentLabelId);
          setInterval(() => refreshInbox(currentLabelId), 120000);
        } else {
          console.warn('No access token retrieved');
        }
      },
    });

    // Try silent refresh first
    if (promptMode === 'none') {
      tokenClient.requestAccessToken();
    }
  }

  window.onload = function () {
    if (window.google && google.accounts) {
      initializeTokenClient('none'); // try silent login
    } else {
      setTimeout(() => {
        if (window.google && google.accounts) {
          initializeTokenClient('none');
        }
      }, 1000);
    }

    // Restore compose box state
    const savedState = localStorage.getItem('composeCollapsed');
    const form = document.getElementById('composeForm');
    const toggleBtn = document.querySelector('#composeBox button');
    const floatingBtn = document.getElementById('composeToggleBtn');

    if (savedState === 'true') {
      if (form && toggleBtn) {
        form.style.display = 'none';
        toggleBtn.textContent = '➕';
        floatingBtn.style.display = 'block';
      }
    }
  };

  function toggleCompose() {
    const form = document.getElementById('composeForm');
    const toggleBtn = event.target;
    const isCollapsed = form.style.display === 'none';
    form.style.display = isCollapsed ? 'block' : 'none';
    toggleBtn.textContent = isCollapsed ? '➖' : '➕';
    document.getElementById('composeToggleBtn').style.display = isCollapsed ? 'none' : 'block';
    localStorage.setItem('composeCollapsed', isCollapsed ? 'false' : 'true');
  }

  function showCompose() {
    const form = document.getElementById('composeForm');
    const toggleBtn = document.querySelector('#composeBox button');
    form.style.display = 'block';
    toggleBtn.textContent = '➖';
    document.getElementById('composeToggleBtn').style.display = 'none';
    localStorage.setItem('composeCollapsed', 'false');
  }

  function sendEmail() {
    const to = document.getElementById("toEmail").value;
    const subject = document.getElementById("emailSubject").value;
    const body = document.getElementById("emailBody").value;

    if (!to || !subject || !body) {
      alert("Please fill in all fields.");
      return;
    }

    const message =
      `To: ${to}\r\n` +
      `Subject: ${subject}\r\n` +
      `Content-Type: text/plain; charset="UTF-8"\r\n` +
      `\r\n${body}`;

    const encodedMessage = btoa(message)
      .replace(/\+/g, '-')
      .replace(/\//g, '_')
      .replace(/=+$/, '');

    fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/send', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${access_token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ raw: encodedMessage })
    })
    .then(res => {
      if (res.ok) {
        alert("Email sent!");
        document.getElementById("toEmail").value = '';
        document.getElementById("emailSubject").value = '';
        document.getElementById("emailBody").value = '';
      } else {
        alert("Failed to send email.");
      }
    })
    .catch(err => {
      console.error(err);
      alert("Error sending email.");
    });
  }
</script>
